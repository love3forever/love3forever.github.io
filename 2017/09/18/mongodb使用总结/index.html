<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="mongodb使用总结"/>




  <meta name="keywords" content="mongodb,总结," />




  <link rel="alternate" href="/default" title="搬砖工的日常">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.4.x" />



<link rel="canonical" href="http://eclipsesv.com/2017/09/18/mongodb使用总结/"/>


<meta name="description" content="本想上周末写好这篇总结的，无奈一起开黑的时间总是过得很快，就偷了个懒，并且还学了个新菜：西红柿牛腩.jpg。所以就把总结的事情放到今天来了。初次接触mongodb还是在研一刚入学的时候，那时候接触的东西少，很多概念都不清楚，到现在差不多已经有三年了，所以总结一下我用mongodb做了哪些事情还是比较有意义的。">
<meta name="keywords" content="mongodb,总结">
<meta property="og:type" content="article">
<meta property="og:title" content="mongodb使用总结">
<meta property="og:url" content="http://eclipsesv.com/2017/09/18/mongodb使用总结/index.html">
<meta property="og:site_name" content="搬砖工的日常">
<meta property="og:description" content="本想上周末写好这篇总结的，无奈一起开黑的时间总是过得很快，就偷了个懒，并且还学了个新菜：西红柿牛腩.jpg。所以就把总结的事情放到今天来了。初次接触mongodb还是在研一刚入学的时候，那时候接触的东西少，很多概念都不清楚，到现在差不多已经有三年了，所以总结一下我用mongodb做了哪些事情还是比较有意义的。">
<meta property="og:locale" content="zh-cn">
<meta property="og:updated_time" content="2017-09-18T09:28:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mongodb使用总结">
<meta name="twitter:description" content="本想上周末写好这篇总结的，无奈一起开黑的时间总是过得很快，就偷了个懒，并且还学了个新菜：西红柿牛腩.jpg。所以就把总结的事情放到今天来了。初次接触mongodb还是在研一刚入学的时候，那时候接触的东西少，很多概念都不清楚，到现在差不多已经有三年了，所以总结一下我用mongodb做了哪些事情还是比较有意义的。">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.4.x" />



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />





<script>
  var CONFIG = {
    search: true,
    searchPath: "/search.xml",
    fancybox: true,
    toc: true,
  }
</script>




  



    <title> mongodb使用总结 · 搬砖工的日常 </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">搬砖工的日常</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            Tags
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            Categories
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">搬砖工的日常</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
      
        <li class="menu-search">
          <form>
            <i class="iconfont icon-search" id="open-search"></i>
            <input type="text" class="search-input" id="search-input" />
            <i class="iconfont icon-close" id="close-search"></i>
          </form>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          mongodb使用总结
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年9月18日
        </span>
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#我的使用场景"><span class="toc-text">我的使用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#海量瓦片数据存储管理"><span class="toc-text">海量瓦片数据存储管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#矢量数据存储和管理"><span class="toc-text">矢量数据存储和管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一般性json格式数据存储管理"><span class="toc-text">一般性json格式数据存储管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#aggregation"><span class="toc-text">aggregation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ttl索引和explain"><span class="toc-text">ttl索引和explain()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据备份和还原"><span class="toc-text">数据备份和还原</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pymongo的使用"><span class="toc-text">pymongo的使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#未用到的特性"><span class="toc-text">未用到的特性</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <p>本想上周末写好这篇总结的，无奈一起开黑的时间总是过得很快，就偷了个懒，并且还学了个新菜：西红柿牛腩.jpg。所以就把总结的事情放到今天来了。<br>初次接触mongodb还是在研一刚入学的时候，那时候接触的东西少，很多概念都不清楚，到现在差不多已经有三年了，所以总结一下我用mongodb做了哪些事情还是比较有意义的。<br><a id="more"></a></p>
<h2 id="我的使用场景"><a href="#我的使用场景" class="headerlink" title="我的使用场景"></a>我的使用场景</h2><p>关于mongodb的介绍，我在这里就不赘述了。mongodb在我这里主要的用途有以下几点：</p>
<pre><code>1. 海量瓦片数据存储管理
2. 矢量数据存储管理
3. 一般性json数据存储管理
</code></pre><p>下面会分别根据使用场景总结在使用过程中使用到的mongodb特性。</p>
<h2 id="海量瓦片数据存储管理"><a href="#海量瓦片数据存储管理" class="headerlink" title="海量瓦片数据存储管理"></a>海量瓦片数据存储管理</h2><p>这里说的海量瓦片数据，可以把它当作是大量小文件。具体的应用可以看<a href="https://eclipsesv.com/2015/07/31/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E7%BC%93%E5%AD%98%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">服务器端缓存环境配置</a>和<a href="https://eclipsesv.com/2015/08/17/Mongodb%E5%89%AF%E6%9C%AC%E9%9B%86%E5%9C%A8nginx-gridfs%E4%B8%AD%E7%9A%84%E4%BD%BF%E7%94%A8/">Mongodb副本集在nginx-gridfs中的使用</a>相关的几篇博客。通过<a href="http://nginx.org/" target="_blank" rel="noopener">nginx</a>+<a href="https://github.com/mdirolf/nginx-gridfs" target="_blank" rel="noopener">nginx-gridfs</a>的简单配置和非常简单的lua逻辑控制脚本，就可以直接根据请求url来获取mongodb gridfs中对应的文件。<br>由于那时候才刚接触这些东西，有很多现在看来比较简单的问题，都绕了不少弯子，比如说：不知道mongodb如何备份数据(所以更别提还原备份了)，每次迁移数据库都是直接拷贝db文件夹(不同数据库版本和不同的操作系统经常会导致失败)；不知道数据库索引是什么用，在数据量较大的时候经常查询超时；不懂操作系统，在服务器上必须有图形界面才可以操作…<br>在用惯了这套组合之后，后边还在nginx和mongodb中间加了redis作为缓存，以提升数据索引效率、在一个全景地图项目中，使用gridfs来管理大量的全景图片、现在工作的项目中，也尝试使用mongodb来管理瓦片数据。</p>
<h2 id="矢量数据存储和管理"><a href="#矢量数据存储和管理" class="headerlink" title="矢量数据存储和管理"></a>矢量数据存储和管理</h2><p>这里说的矢量数据指的是ESRI公司开发的shapefile。在之前的使用过程中，使用mongodb管理矢量数据，主要是想要管理矢量数据中包含的空间和属性信息，所以将shapefile转为geojson之后再由mongodb管理是一个不错的选择。通常可以使用gdal来完成shapefile–&gt;geojson这一步的转换工作。完成数据转换之后，mongodb可以很方便的存储和组织geojson数据。在进行空间数据的索引的时候，mongodb的2d和2dsphere索引提供的一系列操作能够完成很多任务：<br><strong>2dsphere</strong>索引仅支持球面查询，<strong>2d</strong>索引支持平面查询和部分球面查询。这两个索引支持的操作主要有以下这些：</p>
<ol>
<li><p>$near<br> 定义：在一次空间查询中，指定一个点，按照离指定点距离由近到远的顺序返回查询结果。这个指定点可以是一个geopoint或者是一个传统的坐标点。<br> 在使用$near进行查询的时候，根据指定点类型的不同需要不同的空间索引，如果指定点是一个geopoint则需要查询的字段建立2dsphere索引，如果是一个传统的坐标点，则需要建立2d索引。<br> 进行$near查询的时候，使用语法如下：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &lt;location field&gt;: &#123;</span><br><span class="line">     $near: &#123;</span><br><span class="line">       $geometry: &#123;</span><br><span class="line">          type: &quot;Point&quot; ,</span><br><span class="line">          coordinates: [ &lt;longitude&gt; , &lt;latitude&gt; ]</span><br><span class="line">       &#125;,</span><br><span class="line">       $maxDistance: &lt;distance in meters&gt;,</span><br><span class="line">       $minDistance: &lt;distance in meters&gt;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> ⚠️<br> 这里需要注意的是，如果指定点是geopoint，可以在查询的时候指定minDistance；如果指定点是传统坐标点的时候，minDistance不可用，并且maxDistance以弧度为单位。<br> 在分了片的数据库中，$near是不可用的，可以使用geoNear命令或者$geoNear进行聚合操作。</p>
</li>
<li>$nearSphere<br> 此方法和$near功能一致。</li>
<li><p>$geoWithin<br> 定义：将处于指定区域内的所有元素返回。指定区域可以是geojson格式的<code>Polygon</code>或者<code>MultiPolygon</code>或者是传统坐标对序列。<br> 使用语法:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &lt;location field&gt;: &#123;</span><br><span class="line">      $geoWithin: &#123;</span><br><span class="line">         $geometry: &#123;</span><br><span class="line">            type: &lt;&quot;Polygon&quot; or &quot;MultiPolygon&quot;&gt; ,</span><br><span class="line">            coordinates: [ &lt;coordinates&gt; ]</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;或者是</span><br><span class="line">&#123;</span><br><span class="line">   &lt;location field&gt;: &#123;</span><br><span class="line">      $geoWithin: &#123; &lt;shape operator&gt;: &lt;coordinates&gt; &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 根据指定区域构造的方式不同，使用不同的方法，如果指定区域是geojson格式的就用<code>$geometry</code>操作符，如果指定区域是传统坐标对，可用的操作符就有：<code>$box</code>、<code>$polygon</code>、<code>$center</code>和<code>$centerSphere</code>。<br> ⚠️<br> $geoWithin不需要专门创建空间所以，但是有空间索引可以提高检索效率，并且<code>2dsphere</code>和<code>2d</code>索引均支持<code>$geoWithin</code>。<br> $geoWithin返回的结果是无序的，所以它的查询通常要比<code>$near</code>或者是<code>$geoNear</code>快。<br> 如果指定区域过大(超过半球面)的时候，需要指定mongodb的空间参考：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">db.places.find(</span><br><span class="line">   &#123;</span><br><span class="line">     loc: &#123;</span><br><span class="line">       $geoWithin: &#123;</span><br><span class="line">          $geometry: &#123;</span><br><span class="line">             type : &quot;Polygon&quot; ,</span><br><span class="line">             coordinates: [</span><br><span class="line">               [</span><br><span class="line">                 [ -100, 60 ], [ -100, 0 ], [ -100, -60 ], [ 100, -60 ], [ 100, 60 ], [ -100, 60 ]</span><br><span class="line">               ]</span><br><span class="line">             ],</span><br><span class="line">             crs: &#123;</span><br><span class="line">                type: &quot;name&quot;,</span><br><span class="line">                properties: &#123; name: &quot;urn:x-mongodb:crs:strictwinding:EPSG:4326&quot; &#125;</span><br><span class="line">             &#125;</span><br><span class="line">          &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p> 在使用<code>$box</code>操作符的时候：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &lt;location field&gt;: &#123;</span><br><span class="line">     $geoWithin: &#123;</span><br><span class="line">        $box: [</span><br><span class="line">          [ &lt;bottom left coordinates&gt; ],</span><br><span class="line">          [ &lt;upper right coordinates&gt; ]</span><br><span class="line">        ]</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 在使用<code>$polygon</code>操作符的时候：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &lt;location field&gt;: &#123;</span><br><span class="line">      $geoWithin: &#123;</span><br><span class="line">         $polygon: [ [ &lt;x1&gt; , &lt;y1&gt; ], [ &lt;x2&gt; , &lt;y2&gt; ], [ &lt;x3&gt; , &lt;y3&gt; ], ... ]</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 在使用<code>$center</code>的时候：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &lt;location field&gt;: &#123;</span><br><span class="line">      $geoWithin: &#123; $center: [ [ &lt;x&gt;, &lt;y&gt; ] , &lt;radius&gt; ] &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 在使用<code>$centerSphere</code>的时候：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &lt;location field&gt;: &#123;</span><br><span class="line">      $geoWithin: &#123; $centerSphere: [ [ &lt;x&gt;, &lt;y&gt; ], &lt;radius&gt; ] &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>$geoIntersects<br> 定义：返回和指定区域相交的元素，指定区域通常是一个geojson格式的<code>Polygon</code>。<br> 使用语法：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &lt;location field&gt;: &#123;</span><br><span class="line">     $geoIntersects: &#123;</span><br><span class="line">        $geometry: &#123;</span><br><span class="line">           type: &quot;&lt;GeoJSON object type&gt;&quot; ,</span><br><span class="line">           coordinates: [ &lt;coordinates&gt; ]</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> ⚠️<br> 和<code>$geoWithin</code>一样，<code>$geoIntersects</code>不需要专门创建空间索引，但是空间索引能够提升检索效率，但是它仅支持<code>2dsphere</code>索引。<br> 在进行超过半球面的检索时，同样需要指定空间参考：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">db.places.find(</span><br><span class="line">   &#123;</span><br><span class="line">     loc: &#123;</span><br><span class="line">       $geoIntersects: &#123;</span><br><span class="line">          $geometry: &#123;</span><br><span class="line">             type : &quot;Polygon&quot;,</span><br><span class="line">             coordinates: [</span><br><span class="line">               [</span><br><span class="line">                 [ -100, 60 ], [ -100, 0 ], [ -100, -60 ], [ 100, -60 ], [ 100, 60 ], [ -100, 60 ]</span><br><span class="line">               ]</span><br><span class="line">             ],</span><br><span class="line">             crs: &#123;</span><br><span class="line">                type: &quot;name&quot;,</span><br><span class="line">                properties: &#123; name: &quot;urn:x-mongodb:crs:strictwinding:EPSG:4326&quot; &#125;</span><br><span class="line">             &#125;</span><br><span class="line">          &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>通过上述的几个方法，能过满足空间数据的常规索引需求。<br>上述两种场景主要是为了应对和空间信息相关的数据，在实际的使用中，更多的是普通的json格式数据。</p>
<h2 id="一般性json格式数据存储管理"><a href="#一般性json格式数据存储管理" class="headerlink" title="一般性json格式数据存储管理"></a>一般性json格式数据存储管理</h2><p>在更多的时候，使用mongodb主要是用来给web服务提供数据。现在前后端分离的开发方式，前后端之间的交互转变为数据的交互，我的套路就是vue+flask-restful+mongodb。<br>由于mongodb对json格式的数据存储有先天的优势，所以在写代码的时候会剩很多事，合理的使用mongodb的一些特性会有更大的便利。</p>
<h3 id="aggregation"><a href="#aggregation" class="headerlink" title="aggregation"></a>aggregation</h3><p>之前记录过mongodb的aggreagtion相关的内容:<a href="https://eclipsesv.com/2016/11/23/mongodb_Aggregation/">Mongodb Aggregation Pipleline</a>和<a href="https://eclipsesv.com/2017/07/25/mongodb%E6%9C%80%E8%BF%91%E9%A2%91%E7%B9%81%E9%9C%80%E8%A6%81%E7%9C%8B%E7%9A%84%E6%96%87%E6%A1%A3/">mongodb最近频繁看的文档</a>。<br>由于mongodb对跨表查询支持的不是很好，所以在数据存储的时候经常会尽可能的将所需要的数据都放在同一个document里边。但是在实际进行数据请求的时候，可能需要对获取到的数据进行对应的处理，这个时候mongodb的aggregation就能起到作用。直接利用数据库的能力完成数据处理，通常会比拿到数据之后再通过自己的代码完成数据处理要好得多。</p>
<h3 id="ttl索引和explain"><a href="#ttl索引和explain" class="headerlink" title="ttl索引和explain()"></a>ttl索引和explain()</h3><p>这两个点在之前的一个博客里边提到过：<a href="https://eclipsesv.com/2016/11/25/%E8%AF%BBMongodb%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E6%9C%89%E6%84%9F/">读Mongodb权威指南有感</a>。<br>ttl索引可用的面还是挺广的，用以记录缓存过期、验证码或者各类时效性的数据。<br>explain()方法在进行数据库性能调优的过程中也会有很好的效果。</p>
<h3 id="数据备份和还原"><a href="#数据备份和还原" class="headerlink" title="数据备份和还原"></a>数据备份和还原</h3><p>整库的还原和备份，可以直接通过mongodb自带的工具<code>mongodump</code>和<code>mongorestore</code>来完成：<br>通过<code>mongodump -d database_name -o /path/to/dump_dir --gzip</code>来完成备份，<code>mongorestore -d database_name --dir /path/to/dump_dir --gzip</code>来完成还原。<br>当然，如果两个数据库实例在同一个局域网内，也可以直接在mongo中执行命令来完成database或者是collection的迁移：<br>使用cloneCollection命令或者db.cloneCollection()来完成collection的数据迁移：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.runCommand( &#123; cloneCollection: &quot;users.profiles&quot;,</span><br><span class="line">                 from: &quot;mongodb.example.net:27017&quot;,</span><br><span class="line">                 query: &#123; &apos;active&apos; : true &#125;</span><br><span class="line">               &#125; )</span><br><span class="line"></span><br><span class="line">db.cloneCollection(&apos;mongodb.example.net:27017&apos;, &apos;users.profile&apos;,</span><br><span class="line">                    &#123; &apos;active&apos; : true &#125; )</span><br></pre></td></tr></table></figure></p>
<p>⚠️<br>mongos不支持上述两种方法，并且如果目标服务器的mongodb实例开启<code>authorization</code>这两个方法也是不可以用的。<br>类似的，使用下边两个方法来完成整个库的拷贝。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use importdb</span><br><span class="line">db.cloneDatabase(&quot;hostname&quot;)</span><br><span class="line"></span><br><span class="line">&#123; clone: &quot;db1.example.net:27017&quot; &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="pymongo的使用"><a href="#pymongo的使用" class="headerlink" title="pymongo的使用"></a>pymongo的使用</h3><p>使用flask-restful提供数据服务，用到mongodb的地方我都是直接使用pymongo来操作数据库。在使用的过程中有几点，可以记下：</p>
<ol>
<li>在使用flask的jsonify的时候，不能直接把mongodb返回的一整条数据jsonify，这是因为ObjectId不能直接转为json，通常我在查询数据的时候不返回ObjectId</li>
<li>在进行排序或者建立索引的时候，会用到<code>ASCENDING</code>和<code>DESCENDING</code>，升序和降序。需要<code>from pymongo import DESCENDING, ASCENDING</code>，当然还有其他一些索引类型，也都需要从pymongo中直接import</li>
<li><p>在数据量很大的时候，将整个数据集返回，然后逐条操作。整个过程可能会耗费较长的时间，这个时候需要设置<code>no_cursor_timeout</code>，就像这样：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def gen_playlists():</span><br><span class="line">    playlists = col.find(&#123;&#125;, &#123;&apos;_id&apos;: 0&#125;, no_cursor_timeout=True)</span><br><span class="line">    for playlist in playlists:</span><br><span class="line">        yield playlist</span><br><span class="line">    playlists.close()</span><br></pre></td></tr></table></figure>
<p> <code>no_cursor_timeout</code>默认设置为<code>False</code>，如果<code>find()</code>返回的结果集中的某个<code>cursor</code>在十分钟以内没有被操作，这个查询结果就会被关闭。在将<code>no_cursor_timeout</code>设置为<code>True</code>的时候，需要在数据操作完成之后手动关闭查询结果。</p>
</li>
<li>给mongodb设置用户名密码是保证数据安全的一个常用方法，这篇<a href="https://eclipsesv.com/2017/01/17/mongodb%E5%B8%A6%E5%AF%86%E7%A0%81%E9%AA%8C%E8%AF%81%E4%BD%BF%E7%94%A8/">mongodb带密码验证使用</a>博客里边有详细的说明。</li>
</ol>
<h2 id="未用到的特性"><a href="#未用到的特性" class="headerlink" title="未用到的特性"></a>未用到的特性</h2><p>虽说是前前后后差不多已经用了三年的mongodb，但总体说来也就达到了会用的程度。mongodb的分片到现在也没有实际的应用经验，很多有用的索引类型也都没用过，并且也没有实实在在优化数据库性能的经验，所以还有很多要学的。大致从一下几点努力：</p>
<ol>
<li>仔细阅读官方文档</li>
<li>在以后的小项目中尽量使用更多的数据库新特性</li>
<li>除了pymongo以外，其他的driver也接触使用</li>
<li>尝试学习mongodb内部实现细节，比如geohash算法的实现</li>
</ol>

      
    </div>

    
      
      



      
      
  <div class="post-reward">
    <input type="checkbox" name="reward" id="reward" hidden />
    <label class="reward-button" for="reward">赞赏支持</label>
    <div class="qr-code">
      
      
        <label class="qr-code-image" for="reward">
          <img class="image" src="https://o3sw4xojp.qnssl.com/wpay.jpg" title="wechat">
        </label>
      
      
        <label class="qr-code-image" for="reward">
          <img class="image" src="https://o3sw4xojp.qnssl.com/apay.jpg" title="alipay">
        </label>
      
    </div>
  </div>

    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/mongodb/">mongodb</a>
            
              <a href="/tags/总结/">总结</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2017/09/26/一次异步任务的执行过程/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">一次异步任务的执行过程</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2017/08/28/proxy在爬虫中的使用姿势/">
        <span class="next-text nav-default">proxy在爬虫中的使用姿势</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://eclipse-sv.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
  </div>


        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:eclipse_sv@163.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/love3forever" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
    
    
      
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">eclipsesv</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  

  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://eclipsesv.com/2017/09/18/mongodb使用总结/';
        this.page.identifier = '2017/09/18/mongodb使用总结/';
        this.page.title = 'mongodb使用总结';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//eclipse-sv.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>

  




    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.4.x"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.4.x"></script>

    
  <script type="text/html" id="search-result">
    <article class="post">
      <header class="post-header">
        <h1 class="post-title">
          <a href="$url$" class="post-link">
            $title$
          </a>
        </h1>
      </header>
      <div class="post-content">
        $content$
        <div class="read-more">
          <a href="$url$" class="read-more-link">
            阅读更多
          </a>
        </div>
      </div>
    </article>
  </script>
  <script type="text/html" id="no-search-result">
    <div class="no-result">
      <h2>No result found!</h2>
    </div>
  </script>
  <script type="text/javascript" src="/js/src/search.js?v=2.4.x"></script>

  </body>
</html>
